#!/usr/bin/env bash

set -euo pipefail

command=${1:-}
args=${@:2}
firstArg=${2:-}

SOURCE="${BASH_SOURCE[0]}"
while [ -h "$SOURCE" ]; do
	HARPOON_ROOT="$( cd -P "$( dirname "$SOURCE" )" && pwd )"
	SOURCE="$( readlink "$SOURCE" )"
	[[ ${SOURCE} != /* ]] && SOURCE="$HARPOON_ROOT/$SOURCE"
done
export HARPOON_ROOT="$( cd -P "$( dirname "$SOURCE" )" && pwd )"

export HARPOON_TASKS_ROOT=${HARPOON_ROOT}/tasks
export HARPOON_SERVICES_ROOT=${HARPOON_ROOT}/services
export HARPOON_VENDOR_ROOT=${HARPOON_ROOT}/vendor
export HARPOON_IMAGES_ROOT=${HARPOON_ROOT}/images
export HARPOON_LIB_ROOT=${HARPOON_ROOT}/lib

if [[ "$command" == "initpath" ]]; then
	echo "${HARPOON_ROOT}/completion/init.sh" && exit 0
fi


# functions
for f in $(ls ${HARPOON_ROOT}/core/func); do
	source ${HARPOON_ROOT}/core/func/${f}
done


# variables
for f in $(ls ${HARPOON_ROOT}/core/vars); do
	source ${HARPOON_ROOT}/core/vars/${f}
done

source ${HARPOON_ROOT}/core/parse.sh

moduleName=$(parseModule ${command})

if [[ -v USE_DIND && "$moduleName" != "dind" ]]; then
	printInfo "Harpoon is running in dind mode"
	${HARPOON_DIND_EXEC_TTY} harpoon "$@"
	exit $?
fi

# this should always be loaded AFTER core vars and func
source ${HARPOON_ROOT}/core/boot.sh

source ${HARPOON_TASKS_ROOT}/tasks.sh

source ${HARPOON_SERVICES_ROOT}/services.sh

# setup temp directory
mkdir -p ${HARPOON_TEMP}

case "${command}" in
	compose) ## <arg>... %% üê≥  Run docker-compose for the Harpoon core services
		${HARPOON_DOCKER_COMPOSE} ${args} ;;

	cmplt)
		source ${HARPOON_ROOT}/completion/completion.sh ;;

	gen-dnsmasq)
		generateDnsmasqConfig ;;

	config-docker)
		configDocker ;;

	config-docker-network)
		configDockerNetwork ;;

	env) ## %% Show environment variables
		if [ -v PAGER ]; then
			env | sort | ${PAGER}
		else
			env | sort
		fi
		;;

	help) ## [<task> | <service>] %% ‚ÅâÔ∏è  Get help
		help ;;

	--help|-h)
		help ;;

	show-docker-host-ip)
		echo ${HARPOON_DOCKER_HOST_IP} ;;

	up) ## %% üèÅ  Install Harpoon and start core services
		up ;;

	install) ## %% Alias for `up`
		up ;;

	down) ## [<all>] %% üîΩ  Stop and remove Harpoon core, and optionally, supporting services
		down ${args} ;;

	uninstall) ## [<all>] %% Alias for `down`
		down ${args} ;;

	reset) ## %% üåØ  Stop, remove, and restart Harpoon core services
		reset ;;

	self-update) ## %% üí´  Update Harpoon and plugins
		selfUpdate ;;

	selfupdate) ## %% Alias for `self-update`
		selfUpdate ;;

	clean) ## [<all>] %% üõÄ  Completely uninstall Harpoon core, and optionally, all supporting services
		clean ${args} ;;

	services:ls) ## %% Alias for `services:list`
		listServices ;;

	services:list) ## %% üëì  List services available in Harpoon
		listServices ;;

	services:status) ## %% üö¶  Display the status for all supporting services
		servicesStatus ;;

	status) ## %% üö•  Display the status of Harpoon core services
		downServices=0
		for i in dnsmasq consul traefik; do
			IS_UP=$(${HARPOON_DOCKER_COMPOSE} ps ${i} | grep 'Up') || true
			if [[ ${IS_UP} ]]; then
				printf "%-20s%s\n" "${i}" "${UP}"
			else
				printf "%-20s%s\n" "${i}" "${DOWN}"
				downServices+=1
			fi
		done
		if [ ${downServices} -gt 0 ]; then
			exit 1
		fi
		;;

	tasks:ls) ## %% Alias for `tasks:list`
		listTasks ;;

	tasks:list) ## %% üëì  List tasks available in Harpoon
		listTasks ;;

	service) ## <name> <command> [<arg>...] %% üçΩ  Run a (docker-compose) command or task for a service
		source ${HARPOON_SERVICES_ROOT}/tasks.sh ;;

	stfu) ## %% ü§ê  Please stop talking
		echo "export HARPOON_SPEECH=false" >> $HOME/harpoon.env.sh ;;

	greet)
		speakGreeting ;;

	radio)
		say -v Fred -r 190 "Fitter. Happier. More productive." ;;

	*)
		if [ "${moduleName}" == "" ]; then printAllHelp; fi

		# try tasks
		taskExists ${moduleName}

		if [ -v TASK_ROOT ]; then
			if [[ "${firstArg:-}" == "--help" || "${firstArg:-}" == "-h" ]]; then
				taskHelp ${moduleName}
				exit $?
			fi

			source ${TASK_ROOT}/handler.sh
		else
			# try services
			svcRoot=$(serviceRoot ${moduleName})

			if [[ "$svcRoot" != "" ]]; then
				handleService ${moduleName} ${command};
			elif [ -v ROOT_TASKS_FILE ]; then
				# try custom task/command handler in working directory
				command=${command#${PROJECT_TASK_PREFIX}:}
				source ${ROOT_TASKS_FILE}
			fi
		fi
esac
